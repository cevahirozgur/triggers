# triggers

# How to create triggers on SQL and how to use triggers?

# Firstly, create a database and give it a name like TRG. Then create an ITEMS table and enter 1000 line record.


DECLARE @I AS INT=1
WHILE @I<=1000
BEGIN
DECLARE @ITEMCODE AS VARCHAR(100)
DECLARE @ITEMNAME AS VARCHAR(100)
SET @ITEMCODE='ITEM000'+CONVERT(VARCHAR,@I)
SET @ITEMNAME='MALZEME'+CONVERT(VARCHAR,@I)

INSERT INTO ITEMS (ITEMCODE,ITEMNAME)
VALUES (@ITEMCODE,@ITEMNAME)

SET @I=@I+1
END

SELECT * FROM ITEMS

# Create a table named ITEMTRANSACTION for input/output operations. Then enter records (1000 line)

DECLARE @I AS INT=0
WHILE @I<10000
BEGIN
DECLARE @ITEMID AS INT
DECLARE @AMOUNT AS INT
DECLARE @DATE AS DATETIME
DECLARE @IOTYPE AS TINYINT
DECLARE @RAND AS INT

SET @ITEMID=CONVERT(INT,RAND()*1000)+1
SET @AMOUNT=CONVERT(INT,RAND()*20)+1
SET @RAND=CONVERT(INT,RAND()*365)
SET @DATE=DATEADD(DAY,@RAND,'2021-01-01')

IF RAND()<0.4
	SET @IOTYPE=1
ELSE
	SET @IOTYPE=0

	SELECT @ITEMID,@AMOUNT,@DATE,@IOTYPE

	INSERT INTO ITEMTRANSACTION(ITEMID,DATE_,AMOUNT,IOTYPE)
	VALUES (@ITEMID,@DATE,@AMOUNT,@IOTYPE)
SET @I=@I+1
END

# Create a dataset with a sub query to view the stock movement in the ITEMS table according to the input and output in the ITEMTRANSACTION table.

SELECT*, INAMOUNT-OUTAMOUNT STOCK FROM
(
SELECT *,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=0) INAMOUNT,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=1) OUTAMOUNT
FROM ITEMS I

) T

# But writing this way is costly. We can find the cost of this operation to SQL Server by typing SET STATISTICS IO ON before SELECT:

SET STATISTICS IO ON

SELECT*, INAMOUNT-OUTAMOUNT STOCK FROM
(
SELECT *,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=0) INAMOUNT,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=1) OUTAMOUNT
FROM ITEMS I

) T

# logical reads 748 yani 748 page

# NOW IT'S TRIGGER TIME !!!

#Firstly, create an ITEMSTOCK table. Enter records into this table but first clean the inside of the ITEMTRANSACTION table 

TRUNCATE TABLE ITEMTRANSACTION 

INSERT INTO ITEMSTOCK (ITEMID,AMOUNT)

SELECT ID, INAMOUNT-OUTAMOUNT STOCK FROM
(
SELECT *,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=0) INAMOUNT,
(SELECT SUM(AMOUNT) FROM ITEMTRANSACTION WHERE ITEMID=I.ID AND IOTYPE=1) OUTAMOUNT
FROM ITEMS I

) T     -- So we put 1000 rows of data in it but their AMOUNT's are null


UPDATE ITEMSTOCK SET AMOUNT=00   --update inside

# Then CREATE TRIGGER (INSERTED TRIGGER)

CREATE TRIGGER TRG_ITEMSTOCK_UPDATE ON ITEMTRANSACTION 
AFTER INSERT
AS
BEGIN
DECLARE @ITEMID AS INT
DECLARE @DATE AS DATETIME
DECLARE @AMOUNT AS INT
DECLARE @IOTYPE AS TINYINT

SELECT @ITEMID =ITEMID, @DATE=DATE_, @AMOUNT=AMOUNT, @IOTYPE=IOTYPE FROM inserted

IF @IOTYPE=1  --ÇIKIŞ İŞLEMİ İSE
	SET @AMOUNT = @AMOUNT*(-1)

UPDATE ITEMSTOCK SET AMOUNT=AMOUNT+@AMOUNT WHERE ITEMID=@ITEMID

END

# Every time we perform an INSERT operation, there will be a change first in ITEMTRANSACTION and then in ITEMSTOCK. 

INSERT INTO ITEMTRANSACTION (ITEMID,DATE_,AMOUNT,IOTYPE)
VALUES (1, '2021-07-03', 10, 0)

SELECT * FROM ITEMTRANSACTION
SELECT * FROM ITEMSTOCK WHERE ITEMID=1

# Run the code again, which will randomly enter 10,000 records into ITEMTRANSACTION at once.

DECLARE @I AS INT=0
WHILE @I<10000
BEGIN
DECLARE @ITEMID AS INT
DECLARE @AMOUNT AS INT
DECLARE @DATE AS DATETIME
DECLARE @IOTYPE AS TINYINT
DECLARE @RAND AS INT

SET @ITEMID=CONVERT(INT,RAND()*1000)+1
SET @AMOUNT=CONVERT(INT,RAND()*20)+1
SET @RAND=CONVERT(INT,RAND()*365)
SET @DATE=DATEADD(DAY,@RAND,'2021-01-01')

IF RAND()<0.4
	SET @IOTYPE=1
ELSE
	SET @IOTYPE=0

	SELECT @ITEMID,@AMOUNT,@DATE,@IOTYPE

	INSERT INTO ITEMTRANSACTION(ITEMID,DATE_,AMOUNT,IOTYPE)
	VALUES (@ITEMID,@DATE,@AMOUNT,@IOTYPE)
SET @I=@I+1
END

# In the other words, ITEMSTOCK table will automatically update itself when an INSERT entry is made every cycle.


# At the end of the day, the reading from ITEMSTACK will be 5 and SQL's costs will be reduced.









